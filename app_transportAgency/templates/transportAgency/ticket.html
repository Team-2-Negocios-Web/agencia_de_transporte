{% extends "base.html" %}
{% load static %}
{% load transportAgency_filters %}

{% block title %}Ticket{% endblock  %}


{% block container %}
    <div class="container">
        <div class="row">
            <div class="shadow col-6 mt-5"  style="padding:25px;margin:auto;">
                <form action="{% url 'transportAgency:ajax_view' %}" method="post" id="frm-ticket"  >
                    {% csrf_token %}
                    <!--Rutas-->
                
                        <div class="mb-3">
                            <label for="route">Rutas</label>
                            <select name="route" id="route" class="form-select">
                                {% for t in trips  %}
                                    <option value="{{t.pk}}">{{t}}</option>
                                    
                                {% endfor %}
                            </select>
                            <button data-url="{% url 'transportAgency:ajax_view' %}"  type="button" id="button_route"  class="btn btn-primary mt-2">Buscar ruta</button>
                        </div>
                    
                    <br>

                    <!--Info de la ruta-->
                    <p id="available">Ticket Disponible: 16</p>
                    <p id="price">Precio: 00.00</p>
                    

                    <hr>

                    <!--Reservacion del ticket a comprar-->
                        <div class="mb-3">
                            <label for="ticket_reservation">Dia de la reservacion: </label>
                            <input type="date" class="form-control"  name="ticket_reservation" id="ticket_reservation" placeholder="">
                        </div>

                    <!--Cliente-->
                    <div class="mb-3">
                        <label for="client">Cliente</label>
                        <select name="client" id="client" class="form-select">
                            {% for c in clients  %}
                                <option value="{{c.pk}}">{{c}}</option>
                            {% endfor %}
                        </select>
                    </div>
    
                    <br>
                 
                    <hr >
            
        
                     <!--Tickets a comprar-->
                        <div class="mb-3">
                            <label for="quantity">Cuantos tickets desea comprar</label>
                            <input type="number" class="form-control" value='1' min='1' name="quantity" id="quantity" placeholder="">
                            <button type="button" class="btn btn-primary mt-2" id="inputs_id">Generar inputs</button>
                            <br>
                        </div>
                         <div class="inputs_clients"></div>
                        <br>
                        <hr>


                    <button 
                        data-token="{{csrf_token}}" 
                        class="shadow btn btn-success" 
                        id="button-confirm" 
                        data-action="confirm" 
                        data-url="{% url 'transportAgency:ajax_view' %}"
                        data-bs-toggle ="modal"
                        data-bs-target="#confirm-ticket"
                    >
                        Confirmar compra
                    </button>



                    <!-- Modal -->
                    <div class="modal fade" id="confirm-ticket" >
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">Confirmar la compra</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body"></div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                    <button 
                                        data-token="{{csrf_token}}" 
                                        data-url="{% url 'transportAgency:ajax_view' %}" 
                                        class="shadow btn btn-dark" 
                                        id="button-reserve" 
                                        data-action="finish" 
                                    >
                                        Proceso de compra
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                
                </form>
            </div>
        </div>
    </div>
    
{% endblock  %}


{% block js %}

    <script>

    $(function(){

            // <=============== Parte del cliente =================================================>
            var addButtonClient = $('#inputs_id')
            var quantity = $('#quantity')
            var inputsClients = $('.inputs_clients')

            $(addButtonClient).click(function(event){
                event.preventDefault()
                
                //Agregar la cantidad de inputs segun la cantidad de boletos
                $('.removed').remove()
                if (quantity.val() > 1){
                    $(inputsClients).append('<h5 class="removed">Acompañantes</h5>')
                    for(var i = 0; i < quantity.val() - 1; i++){
                        $(inputsClients).append(
                            `
                            <div class="removed">
                                <div class="mb-3">
                                    <label for="client${i}">Acompañante# ${i + 1}</label>
                                        <select name="client${i}" id="client${i}" class="form-select">
                                            {% for c in clients  %}
                                                <option value="{{c.pk}}">{{c}}</option>
                                            {% endfor %}
                                        </select>
                                </div>
                            </div>
                            `
                        )
                    }
                }

            })

            // <================= Parte de la ruta para conseguir la informacion ===================>

            var buttonRoute = $('#button_route')

            $(buttonRoute).click(function(event){
                event.preventDefault()

                var $me = $(this)
                var url = $me.data('url')
                var ctx = {'route': $('#route').val()}

                $.get(url, ctx, function(response){

                    //available_tickets

                    $('#price').text(`Precio: ${response.precio}`)
                }, 'json')

            })



            //<================== Parte para la evaluacion de la compra en del ticket por Ajax POST ================> 

           var $buttonReserve = $('#button-reserve') 
           var $buttonConfirm = $('#button-confirm') 

             $buttonConfirm.click(function(event){
                event.preventDefault()
                
                //Variables route
                var $me = $(this)
                var url = $me.data('url')
                var token = $me.data('token')
                var action = $me.data('action')
                    route  = $('#route')
                    client = $('#client')
                    quantity = $('#quantity')
                    date_ticket = $("#ticket_reservation")

                
                var ctx = {
                    'csrfmiddlewaretoken': token,
                    'route'              : route.val(),
                    'client'             : client.val(),
                    'quantity'           : quantity.val(),
                    'action'             : action,
                    'ticket_reservation' : date_ticket.val(),
                    
                }

                $('#confirm-ticket').modal('show')

                $.post(url, ctx, function(response){
                    if(response.error){
                        $('.modal').find('.modal-body').html(response.error)
                    } else {
                        $('.modal').find('.modal-body').html(response.code)
                    }
                    
                    
                    
                })
            })

            $buttonReserve.click(function(event){
                event.preventDefault()
                
                //Variables route
                var $me = $(this)
                var url = $me.data('url')
                var token = $me.data('token')
                var action = $me.data('action')
                    route  = $('#route')
                    client = $('#client')
                    quantity = $('#quantity')
                    date_ticket = $("#ticket_reservation")
                
                
                var ctx = {
                    'csrfmiddlewaretoken': token,
                    'route'              : route.val(),
                    'client'             : client.val(),
                    'quantity'           : quantity.val(),
                    'ticket_reservation' : date_ticket.val(),
                    'action'             : action,
                }

                if (quantity.val() > 1) {
                    for(var i = 0; i < quantity.val() - 1; i++){
                        value = `client${i}` 
                        ctx[value] = $(`#client${i}`).val()
                    }

                }

                console.log(ctx)

                $.post(url, ctx, function(response){
                    $
                    
                    alert("se realizo la compra correctamente")
                    $('#confirm-ticket').modal('hide')
                    
                })
            })

            
    })

    </script>
{% endblock js %}